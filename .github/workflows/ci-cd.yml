name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: ci_test_user
          POSTGRES_PASSWORD: ci_test_password_not_real
          POSTGRES_DB: test_database
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run database migrations
        env:
          DATABASE_URL: postgresql+asyncpg://ci_test_user:ci_test_password_not_real@localhost:5432/test_database
          DATABASE_URL_SYNC: postgresql://ci_test_user:ci_test_password_not_real@localhost:5432/test_database
          COINGECKO_API_KEY: test_key_not_real
          ADMIN_API_KEY: test_admin_key_not_real
        run: |
          alembic upgrade head
      
      - name: Run tests with coverage
        env:
          DATABASE_URL: postgresql+asyncpg://ci_test_user:ci_test_password_not_real@localhost:5432/test_database
          DATABASE_URL_SYNC: postgresql://ci_test_user:ci_test_password_not_real@localhost:5432/test_database
          COINGECKO_API_KEY: test_key_not_real
          ADMIN_API_KEY: test_admin_key_not_real
        run: |
          pytest tests/ -v --cov=. --cov-report=xml --cov-report=term-missing
      
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml
          fail_ci_if_error: false
  
  lint:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort mypy
      
      - name: Run Black (formatting check)
        run: |
          black --check . || echo "‚ö†Ô∏è Formatting issues found - run 'black .' to fix"
      
      - name: Run isort (import sorting)
        run: |
          isort --check-only . || echo "‚ö†Ô∏è Import sorting issues - run 'isort .' to fix"
      
      - name: Run flake8 (linting)
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics || echo "‚ö†Ô∏è Critical errors found"
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
  
  build:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [test, lint]
    if: github.event_name == 'push'
    
    permissions:
      contents: read
      packages: write
      security-events: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
      
      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
      
      - name: Run Trivy security scan
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ fromJSON(steps.meta.outputs.json).tags[0] }}
          format: 'sarif'
          output: 'trivy-results.sarif'
          exit-code: '0'
        continue-on-error: true
      
      - name: Upload Trivy results to GitHub Security
        uses: github/codeql-action/upload-sarif@v4
        if: always() && hashFiles('trivy-results.sarif') != ''
        with:
          sarif_file: 'trivy-results.sarif'
        continue-on-error: true
  
  deploy:
    name: Deploy to AWS ECS
    runs-on: ubuntu-latest
    needs: build
    # Enabled for automatic deployment to AWS ECS
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-2
      
      - name: Update ECS service (API)
        run: |
          echo "üöÄ Deploying API to ECS..."
          aws ecs update-service \
            --cluster kasparro-cluster \
            --service kasparro-api-service \
            --force-new-deployment \
            --region ap-south-2
          
          echo "‚úÖ API deployment initiated"
          echo "‚ÑπÔ∏è New tasks will start while old tasks drain (no downtime)"
      
      - name: Deployment summary
        run: |
          echo "‚ú® Deployment Complete!"
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"
          echo "View logs: aws logs tail /ecs/kasparro-api --follow"

  smoke-test:
    name: Smoke Test (Production)
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-south-2
      
      - name: Wait for new deployment to stabilize
        run: |
          echo "‚è≥ Waiting for new containers to start and become healthy..."
          echo "‚ÑπÔ∏è This may take 2-3 minutes as old tasks drain and new tasks start"
          sleep 120
      
      - name: Get API endpoint
        id: get-endpoint
        run: |
          # Get ECS task public IP for smoke tests
          echo "üîç Fetching healthy running task endpoint..."
          
          MAX_ATTEMPTS=12
          ATTEMPT=0
          FOUND_HEALTHY_TASK=false
          
          while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
            ATTEMPT=$((ATTEMPT + 1))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS to find healthy task..."
            
            # Get all task ARNs for the service
            TASK_ARNS=$(aws ecs list-tasks \
              --cluster kasparro-cluster \
              --service-name kasparro-api-service \
              --desired-status RUNNING \
              --region ap-south-2 \
              --query 'taskArns' \
              --output text)
            
            if [ -z "$TASK_ARNS" ] || [ "$TASK_ARNS" = "None" ]; then
              echo "‚ö†Ô∏è No running tasks found, waiting 10s..."
              sleep 10
              continue
            fi
            
            # Check each task for RUNNING and HEALTHY status
            for TASK_ARN in $TASK_ARNS; do
              TASK_INFO=$(aws ecs describe-tasks \
                --cluster kasparro-cluster \
                --tasks $TASK_ARN \
                --region ap-south-2 \
                --query 'tasks[0].{LastStatus:lastStatus,HealthStatus:healthStatus,ENI:attachments[0].details[?name==`networkInterfaceId`].value|[0]}' \
                --output json)
              
              TASK_STATUS=$(echo "$TASK_INFO" | jq -r '.LastStatus')
              HEALTH_STATUS=$(echo "$TASK_INFO" | jq -r '.HealthStatus')
              ENI_ID=$(echo "$TASK_INFO" | jq -r '.ENI')
              
              echo "Task: $(basename $TASK_ARN) - Status: $TASK_STATUS, Health: $HEALTH_STATUS"
              
              # Accept RUNNING tasks with HEALTHY or UNKNOWN health (no health check configured)
              if [ "$TASK_STATUS" = "RUNNING" ] && { [ "$HEALTH_STATUS" = "HEALTHY" ] || [ "$HEALTH_STATUS" = "UNKNOWN" ]; }; then
                if [ -n "$ENI_ID" ] && [ "$ENI_ID" != "null" ]; then
                  echo "‚úÖ Found healthy running task: $(basename $TASK_ARN)"
                  
                  # Get the public IP
                  PUBLIC_IP=$(aws ec2 describe-network-interfaces \
                    --network-interface-ids $ENI_ID \
                    --region ap-south-2 \
                    --query 'NetworkInterfaces[0].Association.PublicIp' \
                    --output text)
                  
                  if [ -n "$PUBLIC_IP" ] && [ "$PUBLIC_IP" != "None" ]; then
                    API_ENDPOINT="http://${PUBLIC_IP}:8000"
                    echo "üìù Public IP: $PUBLIC_IP"
                    
                    # Test if endpoint is actually reachable
                    echo "üîç Testing endpoint reachability..."
                    HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$API_ENDPOINT/health" --max-time 10 || echo "000")
                    
                    if [ "$HTTP_CODE" = "200" ]; then
                      echo "‚úÖ API endpoint is healthy: $API_ENDPOINT"
                      echo "API_URL=$API_ENDPOINT" >> $GITHUB_OUTPUT
                      FOUND_HEALTHY_TASK=true
                      break 2
                    else
                      echo "‚ö†Ô∏è Task is running but endpoint returned HTTP $HTTP_CODE"
                    fi
                  fi
                fi
              fi
            done
            
            if [ "$FOUND_HEALTHY_TASK" = false ]; then
              echo "‚ö†Ô∏è No healthy responding task found yet, waiting 10s..."
              sleep 10
            fi
          done
          
          if [ "$FOUND_HEALTHY_TASK" = false ]; then
            echo "‚ùå No healthy task found after $MAX_ATTEMPTS attempts"
            exit 1
          fi
      
      - name: Run smoke tests
        env:
          API_URL: ${{ steps.get-endpoint.outputs.API_URL }}
          API_KEY: ${{ secrets.ADMIN_API_KEY }}
        run: |
          chmod +x tests/smoke/smoke_test.sh
          bash tests/smoke/smoke_test.sh
      
      - name: Smoke test results
        if: always()
        run: |
          echo "üß™ Smoke test execution completed"
          echo "Check logs above for test results"

